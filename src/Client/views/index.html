<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>POI</title>
    <!-- <script src="./node_modules/jquery/dist/jquery.js"></script> -->
    <link rel="stylesheet" href="./../node_modules/emoticons/support/skype/emoticons.css">
    <link rel="stylesheet" href="./../css/main/_main.css">
  </head>
  <body>
    <audio id="buzzSound" src="./../audio/msn_nudge_sound.mp3" style="display:none;">
    </audio>
    <div class="mensajes">
      <input type="text" name="name" id="callUser" value="">
      <ul id="messages"></ul>
      <form  action="" >
        <input id="m" autocomplete="off"/><button>Send</button>
      </form>
      <input type="file" id="archivo" name="archivo" value="">
    </div>
    <video autoplay id="local"></video>

    <video autoplay id="pantalla"></video>
    <div class="login">
      <input type="text" name="name" id="userName" value="">
      <button type="button" id="login" name="button">Login</button>
    </div>
    <div class="call">
      <button type="button" name="button" id="callBtn" >Call</button>
      <button type="button" name="buzz" id="buzz">Zumbido</button>
    </div>

    <div class="CheckDiv">
      Picameeeee
    </div>
    <script>
    var $ = global.jQuery = require('./../node_modules/jquery/dist/jquery.js');
    const renderer = require('electron').ipcRenderer
    var io = require('./../node_modules/socket.io-client/dist/socket.io.js')
    const remote = require("electron").remote
    var window = remote.getCurrentWindow()
    var friend;
    renderer.send('opened-chat', 'ok');
    renderer.on('user-return', (event, arg) => {
      console.log(arg)
      friend = arg
    })
    //
    var socket = io('http://localhost:8001');
    var yourConn;
    var stream;
    var name;
    var connectedUser;
    var userName;

    var emoticons = require('emoticons');
    // var definition = {smile:{title:"Smile",codes:[":)",":=)",":-)"]}};
    var definition = {smile:{title:"Smile",codes:[":)",":=)",":-)"]},
                            "sad-smile":{title:"Sad Smile",codes:[":(",":=(",":-("]},
                            "big-smile":{title:"Big Smile",codes:[":D",":=D",":-D",":d",":=d",":-d"]},
                          cool:{title:"Cool",codes:["8)","8=)","8-)","B)","B=)","B-)","(cool)"]},
                          wink:{title:"Wink",codes:[":o",":=o",":-o",":O",":=O",":-O"]},
                          crying:{title:"Crying",codes:[";(",";-(",";=("]},
                          sweating:{title:"Sweating",codes:["(sweat)","(:|"]},
                          speechless:{title:"Speechless",codes:[":|",":=|",":-|"]},
                          kiss:{title:"Kiss",codes:[":*",":=*",":-*"]},
                            "tongue-out":{title:"Tongue Out",codes:[":P",":=P",":-P",":p",":=p",":-p"]},
                          blush:{title:"Blush",codes:["(blush)",":$",":-$",":=$",':">']},
                          wondering:{title:"Wondering",codes:[":^)"]},
                          sleepy:{title:"Sleepy",codes:["|-)","I-)","I=)","(snooze)"]},
                          dull:{title:"Dull",codes:["|(","|-(","|=("]},
                            "in-love":{title:"In love",codes:["(inlove)"]},
                            "evil-grin":{title:"Evil grin",codes:["]:)",">:)","(grin)"]},
                            talking:{title:"Talking",codes:["(talk)"]},
                          yawn:{title:"Yawn",codes:["(yawn)","|-()"]},
                          puke:{title:"Puke",codes:["(puke)",":&",":-&",":=&"]},
                            "doh!":{title:"Doh!",codes:["(doh)"]},
                          angry:{title:"Angry",codes:[":@",":-@",":=@","x(","x-(","x=(","X(","X-(","X=("]},
                            "it-wasnt-me":{title:"It wasn't me",codes:["(wasntme)"]},
                          party:{title:"Party!!!",codes:["(party)"]},
                          worried:{title:"Worried",codes:[":S",":-S",":=S",":s",":-s",":=s"]},
                          mmm:{title:"Mmm...",codes:["(mm)"]},
                          nerd:{title:"Nerd",codes:["8-|","B-|","8|","B|","8=|","B=|","(nerd)"]},
                            "lips-sealed":{title:"Lips Sealed",codes:[":x",":-x",":X",":-X",":#",":-#",":=x",":=X",":=#"]},
                          hi:{title:"Hi",codes:["(hi)"]},
                          call:{title:"Call",codes:["(call)"]},
                          devil:{title:"Devil",codes:["(devil)"]},
                          angel:{title:"Angel",codes:["(angel)"]},
                          envy:{title:"Envy",codes:["(envy)"]},
                          wait:{title:"Wait",codes:["(wait)"]},
                          bear:{title:"Bear",codes:["(bear)","(hug)"]},
                            "make-up":{title:"Make-up",codes:["(makeup)","(kate)"]},
                            "covered-laugh":{title:"Covered Laugh",codes:["(giggle)","(chuckle)"]},
                            "clapping-hands":{title:"Clapping Hands",codes:["(clap)"]},
                          thinking:{title:"Thinking",codes:["(think)",":?",":-?",":=?"]},
                          bow:{title:"Bow",codes:["(bow)"]},
                          rofl:{title:"Rolling on the floor laughing",codes:["(rofl)"]},
                          whew:{title:"Whew",codes:["(whew)"]},
                          happy:{title:"Happy",codes:["(happy)"]},
                          smirking:{title:"Smirking",codes:["(smirk)"]},
                          nodding:{title:"Nodding",codes:["(nod)"]},
                          shaking:{title:"Shaking",codes:["(shake)"]},
                          punch:{title:"Punch",codes:["(punch)"]},
                          emo:{title:"Emo",codes:["(emo)"]},
                          yes:{title:"Yes",codes:["(y)","(Y)","(ok)"]},
                          no:{title:"No",codes:["(n)","(N)"]},
                          handshake:{title:"Shaking Hands",codes:["(handshake)"]},
                          skype:{title:"Skype",codes:["(skype)","(ss)"]},
                          heart:{title:"Heart",codes:["(h)","<3","(H)","(l)","(L)"]},
                            "broken-heart":{title:"Broken heart",codes:["(u)","(U)"]},
                          mail:{title:"Mail",codes:["(e)","(m)"]},
                          flower:{title:"Flower",codes:["(f)","(F)"]},
                          rain:{title:"Rain",codes:["(rain)","(london)","(st)"]},
                          sun:{title:"Sun",codes:["(sun)"]},
                          time:{title:"Time",codes:["(o)","(O)","(time)"]},
                          music:{title:"Music",codes:["(music)"]},
                          movie:{title:"Movie",codes:["(~)","(film)","(movie)"]},
                          phone:{title:"Phone",codes:["(mp)","(ph)"]},
                          coffee:{title:"Coffee",codes:["(coffee)"]},
                          pizza:{title:"Pizza",codes:["(pizza)","(pi)"]},
                          cash:{title:"Cash",codes:["(cash)","(mo)","($)"]},
                          muscle:{title:"Muscle",codes:["(muscle)","(flex)"]},
                          cake:{title:"Cake",codes:["(^)","(cake)"]},
                          beer:{title:"Beer",codes:["(beer)"]},
                          drink:{title:"Drink",codes:["(d)","(D)"]},
                          dance:{title:"Dance",codes:["(dance)","\\o/","\\:D/","\\:d/"]},
                          ninja:{title:"Ninja",codes:["(ninja)"]},star:{title:"Star",codes:["(*)"]},
                          mooning:{title:"Mooning",codes:["(mooning)"]},
                          finger:{title:"Finger",codes:["(finger)"]},
                          bandit:{title:"Bandit",codes:["(bandit)"]},
                          drunk:{title:"Drunk",codes:["(drunk)"]},
                          smoking:{title:"Smoking",codes:["(smoking)","(smoke)","(ci)"]},
                          toivo:{title:"Toivo",codes:["(toivo)"]},
                          rock:{title:"Rock",codes:["(rock)"]},
                          headbang:{title:"Headbang",codes:["(headbang)","(banghead)"]},
                          bug:{title:"Bug",codes:["(bug)"]},
                          fubar:{title:"Fubar",codes:["(fubar)"]},
                          poolparty:{title:"Poolparty",codes:["(poolparty)"]},
                          swearing:{title:"Swearing",codes:["(swear)"]},
                          tmi:{title:"TMI",codes:["(tmi)"]},
                          heidy:{title:"Heidy",codes:["(heidy)"]},
                          myspace:{title:"MySpace",codes:["(MySpace)"]},
                          malthe:{title:"Malthe",codes:["(malthe)"]},
                          tauri:{title:"Tauri",codes:["(tauri)"]},
                          priidu:{title:"Priidu",codes:["(priidu)"]}};
    emoticons.define(definition);
    // var rtc = require('webrtc.io-client');
    // console.log(rtc);
    // ipcRenderer.on('new-message', (event, arg) => {
    //    $('#messages').append($('<li>').text(arg))
    // })


    // $("#login").click(() =>{
    //   userName = {name: $("#userName").val()}
    //   socket.emit('login', JSON.stringify(userName))
    // })

    renderer.on('chat message', (event, arg) => {
      var pMsg =  emoticons.replace(arg.message);
      var newMessage = $("<li>", {
        class: arg.origin,
        html: pMsg
      })
      $('#messages').append(newMessage);
    })

    renderer.on('buzz', (event, arg) => {
      console.log("si llega")
      $("#buzzSound").trigger('play')
    })


    renderer.on('offer', (event, arg) => {
    // socket.on('offer', function(data){
      handleOffer(arg.offer, arg.name)
    })

    renderer.on('answer', (event, arg) => {
    // socket.on('answer', function(data){
      handleAnswer(arg.answer)
    })

    renderer.on('candidate', (event, arg) => {
    // socket.on('candidate', function(data){
      handleCandidate(arg.candidate)
    })

    renderer.on('file transfer', (event, arg) => {
      handleFile(arg.file, arg.token, arg.type)
    })
    //
    // socket.on('notHere', function(data){
    //   alert(data.error)
    // })


    $('form').submit((event) => {
      // ipcRenderer.send('response-message', $('#m').val());
      event.preventDefault();
      var msg = {
        name: friend,
        message: $('#m').val()
      }
      renderer.send('chat message', JSON.stringify(msg))

      var fileSended = $("#archivo")[0].files[0];
      if(fileSended != null){
        var fileName = fileSended.name;
        var fileType = fileSended.type;
        var fileFormat = fileSended.path;
        fileFormat = fileFormat.split("/");
        fileFormat = fileFormat[fileFormat.length-1];
        fileFormat = fileFormat.split(".");
        fileFormat = fileFormat[fileFormat.length-1];
        fileType = fileType.split("/")[0];
        var blobToBase64 = function(blob, cb) {
            var reader = new FileReader();
            reader.onload = function() {
              var dataUrl = reader.result;
              var base64 = dataUrl.split(',')[1];
              cb(base64);
            };
            reader.readAsDataURL(blob);
          };
        blobToBase64(fileSended, function(base64){
          var fileMsg = {
            name: friend,
            file: base64,
            filename: fileName,
            type: fileType,
            format: fileFormat
          }
          renderer.send('file transfer', fileMsg)
        })
      }
      // socket.emit('chat message', JSON.stringify(msg));
      $('#m').val('');
      return false;
    });

    $("#callBtn").click(function(){
      // var friend = $("#callUser").val();
      if(friend.length > 0 ){
        connectedUser= friend;
        handleLogin();
        yourConn.createOffer(
          function(offer){
            var newfriend = {name: friend, offer: offer};
            renderer.send('offer', JSON.stringify(newfriend))
            // socket.emit('offer', JSON.stringify(newfriend));
            yourConn.setLocalDescription(offer);
          },
          function(error){
            console.log(error);
          });
      }
      else{
        alert("Por favor escribe el nombre de tu amigo");
      }
    });

    $("#buzz").click(function(){
      var friend = {
        name: $("#callUser").val()
      };
      renderer.send("buzz", JSON.stringify(friend));
      // socket.emit("buzz", JSON.stringify(friend));
    })

    $(".CheckDiv").click(function(){
      console.log("aqui vaa");
      renderer.send('testPing', 'ok');
    })

    function handleLogin(success){
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedua;
      //
      var constraints = {
        audio: true,
        video: true
      };

      var video = $("#local");
      //
      function successCallback(stream){
        window.stream = stream;
          $("#local").attr("src", window.URL.createObjectURL(stream));

          var configuration = {
            "iceServers": [{ "urls" : "stun:stun.l.google.com:19302"}]
          }

          yourConn = new webkitRTCPeerConnection(configuration)

          yourConn.addStream(stream)
          yourConn.onaddstream = function (e) {
            $("#pantalla").attr("src",window.URL.createObjectURL(e.stream));
          }

          yourConn.onicecandidate = function(event){
            if(event.candidate){
              renderer.send('candidate', {
                name: friend,
                candidate: event.candidate}
              )
              // socket.emit('candidate', {
              //   name: $("#callUser").val(),
              //   candidate: event.candidate})
            }
          }
          yourConn.oniceconnectionstatechange = function(){
            console.log('ICE stare:', yourConn.iceConnectionState);
          }
      }

      function errorCallback(error){
        console.log('navigator.getUserMedia erro: ', error);
      }

      navigator.getUserMedia(constraints, successCallback, errorCallback);
    }

    function handleOffer(offer, name){
      connectedUser = name;
      yourConn.setRemoteDescription(new RTCSessionDescription(offer));
      yourConn.createAnswer(function(answer){
      yourConn.setLocalDescription(answer)
          var newAnswer = {'name': friend, 'answer': answer};
          renderer.send('answer', JSON.stringify(newAnswer))
          // socket.emit('answer', JSON.stringify(newAnswer));
      }, function(error){
        alert("Error en respuesta")
      })
    }

    function handleAnswer(answer){
      yourConn.setRemoteDescription(new RTCSessionDescription(answer));
    }

    function handleCandidate(candidate){
      yourConn.addIceCandidate(new RTCIceCandidate(candidate));
    }

    function handleFile(file, token, type){
      var fileReceived = $("<li />", {
        class: "receivedFile",
      });

      var linkToFile = $("<a />", {
        class: "linkToFile",
        href: "http://localhost:8001/receive/"+type+"/"+file+"/"+token
      });

      var titleFile = $("<span />", {
        class:"titleFile",
        text: file
      });

      linkToFile.append(titleFile);
      fileReceived.append(linkToFile);
      $("#messages").append(fileReceived);
    }

    function makeid()
    {
      var text = "";
      var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

      for( var i=0; i < 15; i++ )
          text += possible.charAt(Math.floor(Math.random() * possible.length));

      return text;
    }
    </script>
  </body>
</html>
